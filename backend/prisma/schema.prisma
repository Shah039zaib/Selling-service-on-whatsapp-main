generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUPER_ADMIN
}

enum WhatsAppAccountStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  BANNED
}

enum OrderStatus {
  PENDING
  PAYMENT_SUBMITTED
  PAID
  REJECTED
  CANCELLED
  COMPLETED
  REFUNDED
}

enum PaymentMethod {
  EASYPAISA
  JAZZCASH
  BANK_TRANSFER
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
  STICKER
  LOCATION
  CONTACT
}

enum AIProviderType {
  CLAUDE
  GEMINI
  GROQ
  COHERE
}

enum ConversationStatus {
  ACTIVE
  WAITING_PAYMENT
  COMPLETED
  ABANDONED
}

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  passwordHash        String    @map("password_hash")
  name                String
  role                UserRole  @default(ADMIN)
  isActive            Boolean   @default(true) @map("is_active")
  lastLoginAt         DateTime? @map("last_login_at")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  auditLogs     AuditLog[]
  orderActions  OrderAction[]

  @@map("users")
}

model WhatsAppAccount {
  id            String                 @id @default(uuid())
  name          String
  phoneNumber   String?                @map("phone_number")
  status        WhatsAppAccountStatus  @default(DISCONNECTED)
  sessionData   String?                @map("session_data") @db.Text
  qrCode        String?                @map("qr_code") @db.Text
  isDefault     Boolean                @default(false) @map("is_default")
  lastConnected DateTime?              @map("last_connected")
  createdAt     DateTime               @default(now()) @map("created_at")
  updatedAt     DateTime               @updatedAt @map("updated_at")

  customers     Customer[]
  messages      Message[]

  @@map("whatsapp_accounts")
}

model Customer {
  id              String            @id @default(uuid())
  phoneNumber     String            @unique @map("phone_number")
  name            String?
  language        String            @default("en")
  whatsappAccount WhatsAppAccount?  @relation(fields: [whatsappAccountId], references: [id])
  whatsappAccountId String?         @map("whatsapp_account_id")
  conversationContext String?       @map("conversation_context") @db.Text
  lastMessageAt   DateTime?         @map("last_message_at")
  totalOrders     Int               @default(0) @map("total_orders")
  totalSpent      Decimal           @default(0) @db.Decimal(12, 2) @map("total_spent")
  isBlocked       Boolean           @default(false) @map("is_blocked")
  blockReason     String?           @map("block_reason")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  messages        Message[]
  orders          Order[]
  conversations   Conversation[]

  @@map("customers")
}

model Service {
  id              String    @id @default(uuid())
  name            String
  description     String    @db.Text
  shortDescription String?  @map("short_description")
  imageUrl        String?   @map("image_url")
  displayOrder    Int       @default(0) @map("display_order")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  packages        Package[]

  @@map("services")
}

model Package {
  id              String    @id @default(uuid())
  service         Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId       String    @map("service_id")
  name            String
  description     String    @db.Text
  price           Decimal   @db.Decimal(10, 2)
  currency        String    @default("PKR")
  duration        String?
  features        String[]
  isPopular       Boolean   @default(false) @map("is_popular")
  displayOrder    Int       @default(0) @map("display_order")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  orders          Order[]

  @@map("packages")
}

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique @map("order_number")
  customer          Customer      @relation(fields: [customerId], references: [id])
  customerId        String        @map("customer_id")
  package           Package       @relation(fields: [packageId], references: [id])
  packageId         String        @map("package_id")
  status            OrderStatus   @default(PENDING)
  paymentMethod     PaymentMethod? @map("payment_method")
  paymentProofUrl   String?       @map("payment_proof_url")
  paymentProofPublicId String?    @map("payment_proof_public_id")
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("PKR")
  notes             String?       @db.Text
  adminNotes        String?       @map("admin_notes") @db.Text
  paidAt            DateTime?     @map("paid_at")
  completedAt       DateTime?     @map("completed_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  actions           OrderAction[]

  @@map("orders")
}

model OrderAction {
  id          String      @id @default(uuid())
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     String      @map("order_id")
  user        User?       @relation(fields: [userId], references: [id])
  userId      String?     @map("user_id")
  action      String
  fromStatus  OrderStatus @map("from_status")
  toStatus    OrderStatus @map("to_status")
  notes       String?     @db.Text
  createdAt   DateTime    @default(now()) @map("created_at")

  @@map("order_actions")
}

model Message {
  id                String            @id @default(uuid())
  customer          Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId        String            @map("customer_id")
  whatsappAccount   WhatsAppAccount?  @relation(fields: [whatsappAccountId], references: [id])
  whatsappAccountId String?           @map("whatsapp_account_id")
  conversation      Conversation?     @relation(fields: [conversationId], references: [id])
  conversationId    String?           @map("conversation_id")
  direction         MessageDirection
  messageType       MessageType       @default(TEXT) @map("message_type")
  content           String            @db.Text
  mediaUrl          String?           @map("media_url")
  mediaPublicId     String?           @map("media_public_id")
  whatsappMessageId String?           @map("whatsapp_message_id")
  isRead            Boolean           @default(false) @map("is_read")
  aiGenerated       Boolean           @default(false) @map("ai_generated")
  aiProvider        String?           @map("ai_provider")
  metadata          Json?
  timestamp         DateTime          @default(now())
  createdAt         DateTime          @default(now()) @map("created_at")

  @@index([customerId, timestamp])
  @@map("messages")
}

model Conversation {
  id              String              @id @default(uuid())
  customer        Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId      String              @map("customer_id")
  status          ConversationStatus  @default(ACTIVE)
  context         Json?
  startedAt       DateTime            @default(now()) @map("started_at")
  endedAt         DateTime?           @map("ended_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  messages        Message[]

  @@map("conversations")
}

model AIProvider {
  id            String          @id @default(uuid())
  name          String
  type          AIProviderType
  apiKey        String          @map("api_key") @db.Text
  model         String?
  dailyLimit    Int             @default(1000) @map("daily_limit")
  usedToday     Int             @default(0) @map("used_today")
  lastResetAt   DateTime        @default(now()) @map("last_reset_at")
  priority      Int             @default(0)
  isActive      Boolean         @default(true) @map("is_active")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  usageLogs     AIUsageLog[]

  @@map("ai_providers")
}

model AIUsageLog {
  id            String      @id @default(uuid())
  provider      AIProvider  @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId    String      @map("provider_id")
  inputTokens   Int         @map("input_tokens")
  outputTokens  Int         @map("output_tokens")
  latencyMs     Int         @map("latency_ms")
  success       Boolean     @default(true)
  errorMessage  String?     @map("error_message")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([providerId, createdAt])
  @@map("ai_usage_logs")
}

model PaymentConfig {
  id            String        @id @default(uuid())
  method        PaymentMethod @unique
  accountTitle  String        @map("account_title")
  accountNumber String        @map("account_number")
  bankName      String?       @map("bank_name")
  instructions  String?       @db.Text
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("payment_configs")
}

model SystemPrompt {
  id            String    @id @default(uuid())
  name          String    @unique
  content       String    @db.Text
  description   String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("system_prompts")
}

model MessageTemplate {
  id            String    @id @default(uuid())
  name          String    @unique
  content       String    @db.Text
  variables     String[]
  description   String?
  category      String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("message_templates")
}

model AuditLog {
  id          String    @id @default(uuid())
  user        User?     @relation(fields: [userId], references: [id])
  userId      String?   @map("user_id")
  action      String
  entity      String
  entityId    String?   @map("entity_id")
  oldData     Json?     @map("old_data")
  newData     Json?     @map("new_data")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemConfig {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String    @db.Text
  description String?
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("system_configs")
}

model RateLimitTracker {
  id          String    @id @default(uuid())
  identifier  String    @unique
  count       Int       @default(0)
  windowStart DateTime  @map("window_start")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("rate_limit_trackers")
}
